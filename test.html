<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048æ¸¸æˆ - å•å…ƒæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #faf8ef;
            color: #776e65;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #776e65;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
        }
        
        .test-section h2 {
            color: #8f7a66;
            border-bottom: 2px solid #bbada0;
            padding-bottom: 10px;
        }
        
        .test-button {
            background: #8f7a66;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            transition: background-color 0.2s;
        }
        
        .test-button:hover {
            background: #9f8a76;
        }
        
        .test-output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-width: 200px;
            margin: 10px 0;
        }
        
        .demo-cell {
            background: #bbada0;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .demo-cell.empty {
            background: rgba(238, 228, 218, 0.35);
            color: transparent;
        }
    </style>
</head>
<body>
    <h1>2048æ¸¸æˆ - å•å…ƒæµ‹è¯•</h1>
    
    <div class="test-container">
        <div class="test-section">
            <h2>MoveProcessor ç®—æ³•æµ‹è¯•</h2>
            <p>æµ‹è¯•ç§»åŠ¨å’Œåˆå¹¶ç®—æ³•çš„æ­£ç¡®æ€§</p>
            <button class="test-button" onclick="runMoveProcessorTests()">è¿è¡Œ MoveProcessor æµ‹è¯•</button>
            <div id="moveprocessor-output" class="test-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>GameEngine å¼•æ“æµ‹è¯•</h2>
            <p>æµ‹è¯•æ¸¸æˆå¼•æ“çš„æ ¸å¿ƒåŠŸèƒ½</p>
            <button class="test-button" onclick="runGameEngineTests()">è¿è¡Œ GameEngine æµ‹è¯•</button>
            <div id="gameengine-output" class="test-output" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>ç®—æ³•æ¼”ç¤º</h2>
            <p>æ¼”ç¤ºä¸åŒç§»åŠ¨æ–¹å‘çš„æ•ˆæœ</p>
            <button class="test-button" onclick="demonstrateAlgorithm()">æ¼”ç¤ºç®—æ³•</button>
            <div id="demo-output" class="test-output" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>æ€§èƒ½æµ‹è¯•</h2>
            <p>æµ‹è¯•ç®—æ³•çš„æ‰§è¡Œæ€§èƒ½</p>
            <button class="test-button" onclick="runPerformanceTests()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div id="performance-output" class="test-output" style="display: none;"></div>
        </div>
    </div>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="js/GameState.js"></script>
    <script src="js/MoveProcessor.js"></script>
    <script src="js/GameEngine.js"></script>
    <script src="tests/MoveProcessor.test.js"></script>
    <script src="tests/GameEngine.test.js"></script>
    
    <script>
        // é‡å®šå‘console.logåˆ°æŒ‡å®šå…ƒç´ 
        function redirectConsole(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = '';
            
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(...args) {
                element.textContent += args.join(' ') + '\n';
                originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
                element.textContent += 'ERROR: ' + args.join(' ') + '\n';
                originalError.apply(console, args);
            };
            
            return function restore() {
                console.log = originalLog;
                console.error = originalError;
            };
        }
        
        // è¿è¡ŒMoveProcessoræµ‹è¯•
        function runMoveProcessorTests() {
            const restore = redirectConsole('moveprocessor-output');
            
            try {
                // é‡æ–°åˆ›å»ºæµ‹è¯•å®ä¾‹å¹¶è¿è¡Œ
                const testFramework = new TestFramework();
                
                // é‡æ–°å®šä¹‰æ‰€æœ‰æµ‹è¯•ï¼ˆç®€åŒ–ç‰ˆï¼‰
                testFramework.test('processLine - åŸºæœ¬æ»‘åŠ¨', () => {
                    const result = MoveProcessor.processLine([2, 0, 2, 0]);
                    testFramework.assertEqual(result.line, [4, 0, 0, 0]);
                    testFramework.assertEqual(result.score, 4);
                });
                
                testFramework.test('moveLeft - åŸºæœ¬ç§»åŠ¨', () => {
                    const grid = [
                        [2, 0, 2, 0],
                        [0, 4, 0, 4],
                        [8, 0, 0, 8],
                        [0, 0, 0, 0]
                    ];
                    
                    const result = MoveProcessor.moveLeft(grid);
                    
                    const expectedGrid = [
                        [4, 0, 0, 0],
                        [8, 0, 0, 0],
                        [16, 0, 0, 0],
                        [0, 0, 0, 0]
                    ];
                    
                    testFramework.assertEqual(result.grid, expectedGrid);
                    testFramework.assertTrue(result.moved);
                });
                
                testFramework.test('canMove - æ£€æŸ¥ç§»åŠ¨èƒ½åŠ›', () => {
                    const grid = [
                        [2, 0, 2, 0],
                        [0, 4, 0, 4],
                        [8, 0, 0, 8],
                        [0, 0, 0, 0]
                    ];
                    
                    testFramework.assertTrue(MoveProcessor.canMove(grid, 'left'));
                    testFramework.assertTrue(MoveProcessor.canMoveAnyDirection(grid));
                });
                
                testFramework.run();
            } catch (error) {
                console.error('æµ‹è¯•æ‰§è¡Œå‡ºé”™:', error);
            } finally {
                restore();
            }
        }

        // è¿è¡ŒGameEngineæµ‹è¯•
        function runGameEngineTests() {
            const restore = redirectConsole('gameengine-output');

            try {
                // é‡æ–°åˆ›å»ºæµ‹è¯•å®ä¾‹å¹¶è¿è¡Œ
                const testFramework = new TestFramework();

                // é‡æ–°å®šä¹‰å…³é”®æµ‹è¯•ï¼ˆç®€åŒ–ç‰ˆï¼‰
                testFramework.test('GameEngineæ„é€ å‡½æ•° - æ­£å¸¸åˆå§‹åŒ–', () => {
                    const gameState = new GameState();
                    const gameEngine = new GameEngine(gameState);

                    testFramework.assertNotNull(gameEngine);
                    testFramework.assertEqual(gameEngine.getVersion(), '1.0.0');
                });

                testFramework.test('initGame - æ­£å¸¸åˆå§‹åŒ–', () => {
                    const gameState = new GameState();
                    const gameEngine = new GameEngine(gameState);

                    gameEngine.initGame();

                    testFramework.assertTrue(gameState.isGameStarted());
                    testFramework.assertFalse(gameState.isGameOver());
                    testFramework.assertFalse(gameState.hasWon());
                    testFramework.assertEqual(gameState.getScore(), 0);

                    // åº”è¯¥æœ‰2ä¸ªåˆå§‹æ–¹å—
                    const emptyTiles = gameState.getEmptyTiles();
                    testFramework.assertEqual(emptyTiles.length, 14); // 16 - 2 = 14
                });

                testFramework.test('move - æœ‰æ•ˆç§»åŠ¨', () => {
                    const gameState = new GameState();
                    const gameEngine = new GameEngine(gameState);

                    // è®¾ç½®æµ‹è¯•ç½‘æ ¼
                    const testGrid = [
                        [2, 0, 2, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ];
                    gameState.setGrid(testGrid);
                    gameState.setGameStarted(true);

                    const result = gameEngine.move('left');

                    testFramework.assertTrue(result);
                    testFramework.assertTrue(gameState.wasLastMoveValid());
                });

                testFramework.test('checkGameStatus - æ¸¸æˆè·èƒœ', () => {
                    const gameState = new GameState();
                    const gameEngine = new GameEngine(gameState);

                    const testGrid = [
                        [2048, 0, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ];
                    gameState.setGrid(testGrid);

                    const status = gameEngine.checkGameStatus();

                    testFramework.assertEqual(status, 'won');
                    testFramework.assertTrue(gameState.hasWon());
                });

                testFramework.test('getGameStats - è·å–ç»Ÿè®¡ä¿¡æ¯', () => {
                    const gameState = new GameState();
                    const gameEngine = new GameEngine(gameState);

                    gameState.setScore(100);
                    gameState.setBestScore(200);

                    const testGrid = [
                        [2, 4, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ];
                    gameState.setGrid(testGrid);

                    const stats = gameEngine.getGameStats();

                    testFramework.assertNotNull(stats);
                    testFramework.assertEqual(stats.score, 100);
                    testFramework.assertEqual(stats.bestScore, 200);
                    testFramework.assertEqual(stats.maxTile, 4);
                });

                testFramework.run();
            } catch (error) {
                console.error('æµ‹è¯•æ‰§è¡Œå‡ºé”™:', error);
            } finally {
                restore();
            }
        }

        // æ¼”ç¤ºç®—æ³•
        function demonstrateAlgorithm() {
            const restore = redirectConsole('demo-output');
            
            try {
                console.log('ğŸ® ç®—æ³•æ¼”ç¤ºå¼€å§‹...\n');
                
                const testGrid = [
                    [2, 0, 2, 4],
                    [0, 4, 0, 4],
                    [8, 0, 8, 0],
                    [0, 2, 0, 2]
                ];
                
                console.log('åˆå§‹ç½‘æ ¼:');
                MoveProcessor.printGrid(testGrid, 'åŸå§‹çŠ¶æ€');
                
                // æ¼”ç¤ºå››ä¸ªæ–¹å‘çš„ç§»åŠ¨
                const directions = ['left', 'right', 'up', 'down'];
                
                for (const direction of directions) {
                    let result;
                    switch (direction) {
                        case 'left':
                            result = MoveProcessor.moveLeft(testGrid);
                            break;
                        case 'right':
                            result = MoveProcessor.moveRight(testGrid);
                            break;
                        case 'up':
                            result = MoveProcessor.moveUp(testGrid);
                            break;
                        case 'down':
                            result = MoveProcessor.moveDown(testGrid);
                            break;
                    }
                    
                    console.log(`å‘${direction}ç§»åŠ¨:`);
                    console.log(`åˆ†æ•°: ${result.score}, æ˜¯å¦ç§»åŠ¨: ${result.moved}`);
                    MoveProcessor.printGrid(result.grid, `${direction}ç§»åŠ¨å`);
                }
                
                console.log('ğŸ‰ ç®—æ³•æ¼”ç¤ºå®Œæˆï¼');
            } catch (error) {
                console.error('æ¼”ç¤ºæ‰§è¡Œå‡ºé”™:', error);
            } finally {
                restore();
            }
        }
        
        // æ€§èƒ½æµ‹è¯•
        function runPerformanceTests() {
            const restore = redirectConsole('performance-output');
            
            try {
                console.log('âš¡ æ€§èƒ½æµ‹è¯•å¼€å§‹...\n');
                
                // åˆ›å»ºéšæœºç½‘æ ¼
                function createRandomGrid() {
                    const grid = [];
                    const values = [0, 0, 0, 0, 2, 2, 4, 8, 16, 32];
                    
                    for (let row = 0; row < 4; row++) {
                        grid[row] = [];
                        for (let col = 0; col < 4; col++) {
                            grid[row][col] = values[Math.floor(Math.random() * values.length)];
                        }
                    }
                    return grid;
                }
                
                const iterations = 10000;
                const testGrid = createRandomGrid();
                
                console.log(`æµ‹è¯•ç½‘æ ¼ (${iterations} æ¬¡è¿­ä»£):`);
                MoveProcessor.printGrid(testGrid);
                
                // æµ‹è¯•å„ä¸ªæ–¹å‘çš„æ€§èƒ½
                const directions = ['left', 'right', 'up', 'down'];
                
                for (const direction of directions) {
                    const startTime = performance.now();
                    
                    for (let i = 0; i < iterations; i++) {
                        switch (direction) {
                            case 'left':
                                MoveProcessor.moveLeft(testGrid);
                                break;
                            case 'right':
                                MoveProcessor.moveRight(testGrid);
                                break;
                            case 'up':
                                MoveProcessor.moveUp(testGrid);
                                break;
                            case 'down':
                                MoveProcessor.moveDown(testGrid);
                                break;
                        }
                    }
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    const avgTime = duration / iterations;
                    
                    console.log(`${direction}ç§»åŠ¨: ${duration.toFixed(2)}ms æ€»è®¡, ${avgTime.toFixed(4)}ms å¹³å‡`);
                }
                
                console.log('\nğŸš€ æ€§èƒ½æµ‹è¯•å®Œæˆï¼');
            } catch (error) {
                console.error('æ€§èƒ½æµ‹è¯•å‡ºé”™:', error);
            } finally {
                restore();
            }
        }
    </script>
</body>
</html>
